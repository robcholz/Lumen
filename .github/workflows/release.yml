# Build and publish a GitHub Release when a tag is pushed.
name: release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-24.04

    steps:
      - name: checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: build with ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.5
          target: esp32c3
          path: .
          command: |
            apt-get update
            apt-get install -y curl ca-certificates build-essential
            curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal
            export PATH="$HOME/.cargo/bin:$PATH"
            rustup update stable
            rustup target add riscv32imc-unknown-none-elf
            idf.py build && (cd build && python -m esptool --chip esp32c3 merge_bin -o lumen_single_bin.bin $(cat flash_args))

      - name: locate firmware bin
        id: bin
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f build/lumen_single_bin.bin ]]; then
            versioned="build/lumen_single_bin_${GITHUB_REF_NAME}.bin"
            mv build/lumen_single_bin.bin "$versioned"
            echo "path=$versioned" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          mapfile -t bins < <(find build -maxdepth 2 -type f -name '*.bin' \
            ! -path 'build/bootloader/*' \
            ! -path 'build/partition_table/*' \
            ! -name 'ota_data_initial.bin' \
            | sort)
          if [[ ${#bins[@]} -eq 0 ]]; then
            echo "No firmware .bin found in build" >&2
            exit 1
          fi
          echo "path=${bins[0]}" >> "$GITHUB_OUTPUT"

      - name: create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          files: ${{ steps.bin.outputs.path }}
